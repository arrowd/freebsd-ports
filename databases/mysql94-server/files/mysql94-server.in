#!/bin/sh

# PROVIDE: mysql
# REQUIRE: LOGIN
# KEYWORD: shutdown

#
# Add the following line to /etc/rc.conf to enable mysql:
# %%SUFXD_NAME%%_enable (bool):	Set to "NO" by default.
#			Set it to "YES" to enable MySQL.
# %%SUFXD_NAME%%_dbdir (str):	Default to "%%MY_DBDIR%%"
#			Base database directory.
# %%SUFXD_NAME%%_confdir (str):	Default to "%%ETCDIR%%"
#			Base configuration directory.
# %%SUFXD_NAME%%_optfile (str):	Server-specific option file.
#			Set it in the rc.conf or default behaviour of
#			`mysqld_safe` itself, will be picking
#			${%%SUFXD_NAME%%_confdir}/my.cnf if it exists.
# %%SUFXD_NAME%%_pidfile (str):	Custom PID file path and name.
#			Default to "${%%SUFXD_NAME%%_dbdir}/${hostname}.pid".
# %%SUFXD_NAME%%_args (str):	Custom additional arguments to be passed
#			to mysqld_safe (default empty).
#

. /etc/rc.subr

name="%%SUFXD_NAME%%"
rcvar=%%SUFXD_NAME%%_enable

load_rc_config $name

: ${%%SUFXD_NAME%%_enable="NO"}
: ${%%SUFXD_NAME%%_dbdir="%%MY_DBDIR%%"}
: ${%%SUFXD_NAME%%_confdir="%%ETCDIR%%"}
if [ -f "${%%SUFXD_NAME%%_confdir}/my.cnf" ]; then
: ${%%SUFXD_NAME%%_optfile="${%%SUFXD_NAME%%_confdir}/my.cnf"}
elif [ -f "${%%SUFXD_NAME%%_dbdir}/my.cnf" ]; then
: ${%%SUFXD_NAME%%_optfile="${%%SUFXD_NAME%%_dbdir}/my.cnf"}
fi
if [ ! -z "${%%SUFXD_NAME%%_optfile}" ]; then
mysql_extra="--defaults-extra-file=${%%SUFXD_NAME%%_optfile}"
fi

mysql_user="mysql"
: ${hostname:=`/bin/hostname`}
pidfile=${%%SUFXD_NAME%%_pidfile:-"${%%SUFXD_NAME%%_dbdir}/${hostname}.pid"}
command="/usr/sbin/daemon"
command_args="-c -f %%PREFIX%%/bin/mysqld_safe ${mysql_extra} --basedir=%%PREFIX%% --datadir=${%%SUFXD_NAME%%_dbdir} --pid-file=${pidfile} --user=${mysql_user} ${%%SUFXD_NAME%%_args} %%FEDER%% %%PERFSCHEMRC%%"
procname="%%PREFIX%%/libexec/mysqld"
start_precmd="mysql_prestart"
start_postcmd="mysql_poststart"
mysqld_init="${procname}"
mysqld_init_args="${mysql_extra} --initialize-insecure --basedir=%%PREFIX%% --datadir=${%%SUFXD_NAME%%_dbdir} --user=${mysql_user}"

mysql_create_auth_tables()
{
	eval $mysqld_init $mysqld_init_args >/dev/null 2>/dev/null
}

mysql_prestart()
{
	if [ ! -d "${%%SUFXD_NAME%%_dbdir}/mysql/." ]; then
		mysql_create_auth_tables || return 1
	fi
	return 0
}

mysql_poststart()
{
	local timeout=15
	while [ ! -f "${pidfile}" -a ${timeout} -gt 0 ]; do
		timeout=$(( timeout - 1 ))
		sleep 1
	done
	return 0
}

run_rc_command "$1"
